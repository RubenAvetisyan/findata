{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/bofa_rollup.schema.json",
  "title": "Bank Statement Rollup (BOFA)",
  "type": "object",
  "additionalProperties": false,
  "required": ["startingBalance", "endingBalance", "totalStatements", "totalTransactions", "accounts", "analytics", "integrity"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "v2"
    },
    "startingBalance": { "type": "number" },
    "endingBalance": { "type": "number" },
    "totalStatements": { "type": "integer", "minimum": 0 },
    "totalTransactions": { "type": "integer", "minimum": 0 },
    "accounts": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/accountBlock" }
    },
    "analytics": { "$ref": "#/$defs/analytics" },
    "integrity": { "$ref": "#/$defs/integrityCheck" }
  },
  "$defs": {
    "isoDate": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "Date in YYYY-MM-DD"
    },
    "statementPeriod": {
      "type": "object",
      "additionalProperties": false,
      "required": ["start", "end"],
      "properties": {
        "start": { "$ref": "#/$defs/isoDate" },
        "end": { "$ref": "#/$defs/isoDate" }
      }
    },
    "accountIdentity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["institution", "accountType", "accountNumberMasked", "statementPeriod", "currency"],
      "properties": {
        "institution": { "type": "string", "minLength": 1 },
        "accountType": {
          "type": "string",
          "enum": ["checking", "savings", "credit", "unknown"]
        },
        "accountNumberMasked": {
          "type": "string",
          "minLength": 4,
          "description": "Masked account number like ****3529"
        },
        "statementPeriod": { "$ref": "#/$defs/statementPeriod" },
        "currency": {
          "type": "string",
          "minLength": 3,
          "maxLength": 3,
          "description": "ISO-4217 currency code, e.g. USD"
        }
      }
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["startingBalance", "endingBalance", "totalCredits", "totalDebits"],
      "properties": {
        "startingBalance": { "type": "number" },
        "endingBalance": { "type": "number" },
        "totalCredits": { "type": "number" },
        "totalDebits": { "type": "number" }
      }
    },
    "direction": {
      "type": "string",
      "enum": ["credit", "debit"]
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "raw": {
      "type": "object",
      "additionalProperties": false,
      "required": ["originalText", "page"],
      "properties": {
        "originalText": { "type": "string" },
        "page": { "type": "integer", "minimum": 1 }
      }
    },
    "transaction": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "date",
        "postedDate",
        "description",
        "merchant",
        "amount",
        "direction",
        "category",
        "subcategory",
        "confidence",
        "statementId",
        "periodLabel",
        "raw"
      ],
      "properties": {
        "date": { "$ref": "#/$defs/isoDate" },
        "postedDate": {
          "anyOf": [
            { "$ref": "#/$defs/isoDate" },
            { "type": "null" }
          ]
        },
        "description": { "type": "string", "minLength": 1 },
        "merchant": { "type": "string", "minLength": 1 },
        "amount": {
          "type": "number",
          "description": "Signed amount allowed; direction indicates semantic (credit/debit)."
        },
        "direction": { "$ref": "#/$defs/direction" },
        "category": { "type": "string" },
        "subcategory": {
          "anyOf": [{ "type": "string" }, { "type": "null" }]
        },
        "confidence": {
          "$ref": "#/$defs/confidence",
          "description": "Parsing/OCR confidence (0-1), not financial correctness. Values < 1.0 indicate extraction uncertainty."
        },
        "statementId": {
          "type": "string",
          "description": "Unique identifier linking transaction to source statement (format: ACCOUNTTYPE-XXXX-YYYYMMDD-YYYYMMDD)"
        },
        "periodLabel": {
          "type": "string",
          "description": "Human-readable statement period label (e.g., '2025-08 BOA Checking')"
        },
        "raw": { "$ref": "#/$defs/raw" }
      }
    },
    "accountBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": ["account", "summary", "transactions", "totalStatements", "totalTransactions"],
      "properties": {
        "account": { "$ref": "#/$defs/accountIdentity" },
        "summary": { "$ref": "#/$defs/summary" },
        "transactions": {
          "type": "array",
          "items": { "$ref": "#/$defs/transaction" }
        },
        "totalStatements": { "type": "integer", "minimum": 0 },
        "totalTransactions": { "type": "integer", "minimum": 0 }
      }
    },
    "quarterlyCashFlow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["quarter", "year", "quarterNumber", "startDate", "endDate", "totalIncome", "totalExpenses", "netCashFlow", "transactionCount"],
      "properties": {
        "quarter": { "type": "string", "pattern": "^\\d{4}-Q[1-4]$" },
        "year": { "type": "integer" },
        "quarterNumber": { "type": "integer", "minimum": 1, "maximum": 4 },
        "startDate": { "$ref": "#/$defs/isoDate" },
        "endDate": { "$ref": "#/$defs/isoDate" },
        "totalIncome": { "type": "number" },
        "totalExpenses": { "type": "number" },
        "netCashFlow": { "type": "number" },
        "transactionCount": { "type": "integer", "minimum": 0 }
      }
    },
    "incomeVsExpenses": {
      "type": "object",
      "additionalProperties": false,
      "required": ["totalIncome", "totalExpenses", "netIncome", "incomeByCategory", "expensesByCategory", "excludedTransfers", "periodStart", "periodEnd"],
      "properties": {
        "totalIncome": { "type": "number" },
        "totalExpenses": { "type": "number" },
        "netIncome": { "type": "number" },
        "incomeByCategory": { "type": "object", "additionalProperties": { "type": "number" } },
        "expensesByCategory": { "type": "object", "additionalProperties": { "type": "number" } },
        "excludedTransfers": { "type": "number" },
        "periodStart": { "$ref": "#/$defs/isoDate" },
        "periodEnd": { "$ref": "#/$defs/isoDate" }
      }
    },
    "monthlyBreakdown": {
      "type": "object",
      "additionalProperties": false,
      "required": ["month", "income", "expenses", "netCashFlow"],
      "properties": {
        "month": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" },
        "income": { "type": "number" },
        "expenses": { "type": "number" },
        "netCashFlow": { "type": "number" }
      }
    },
    "lenderSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["averageMonthlyIncome", "averageMonthlyExpenses", "monthlyIncomeVariance", "incomeStabilityScore", "consecutiveMonthsWithIncome", "totalMonthsAnalyzed", "monthlyBreakdown", "incomeSourceDiversity", "regularIncomeDetected", "estimatedAnnualIncome"],
      "properties": {
        "averageMonthlyIncome": { "type": "number" },
        "averageMonthlyExpenses": { "type": "number" },
        "monthlyIncomeVariance": { "type": "number" },
        "incomeStabilityScore": { "type": "integer", "minimum": 0, "maximum": 100 },
        "consecutiveMonthsWithIncome": { "type": "integer", "minimum": 0 },
        "totalMonthsAnalyzed": { "type": "integer", "minimum": 0 },
        "monthlyBreakdown": { "type": "array", "items": { "$ref": "#/$defs/monthlyBreakdown" } },
        "incomeSourceDiversity": { "type": "integer", "minimum": 0 },
        "regularIncomeDetected": { "type": "boolean" },
        "estimatedAnnualIncome": { "type": "number" }
      }
    },
    "taxCategorySummary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["category", "subcategory", "totalAmount", "transactionCount", "taxRelevance"],
      "properties": {
        "category": { "type": "string" },
        "subcategory": { "anyOf": [{ "type": "string" }, { "type": "null" }] },
        "totalAmount": { "type": "number" },
        "transactionCount": { "type": "integer", "minimum": 0 },
        "taxRelevance": { "type": "string", "enum": ["deductible", "income", "neutral", "review"] }
      }
    },
    "taxDeductionSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["businessExpenses", "medicalExpenses", "charitableContributions", "homeOffice", "professionalServices", "otherDeductible"],
      "properties": {
        "businessExpenses": { "type": "number" },
        "medicalExpenses": { "type": "number" },
        "charitableContributions": { "type": "number" },
        "homeOffice": { "type": "number" },
        "professionalServices": { "type": "number" },
        "otherDeductible": { "type": "number" }
      }
    },
    "taxPreparation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["taxYear", "totalTaxableIncome", "totalDeductibleExpenses", "potentialDeductions", "incomeCategories", "reviewRequired", "summary"],
      "properties": {
        "taxYear": { "type": "integer" },
        "totalTaxableIncome": { "type": "number" },
        "totalDeductibleExpenses": { "type": "number" },
        "potentialDeductions": { "type": "array", "items": { "$ref": "#/$defs/taxCategorySummary" } },
        "incomeCategories": { "type": "array", "items": { "$ref": "#/$defs/taxCategorySummary" } },
        "reviewRequired": { "type": "array", "items": { "$ref": "#/$defs/taxCategorySummary" } },
        "summary": { "$ref": "#/$defs/taxDeductionSummary" }
      }
    },
    "analytics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["quarterlyCashFlow", "incomeVsExpenses", "lenderSummary", "taxPreparation"],
      "properties": {
        "quarterlyCashFlow": { "type": "array", "items": { "$ref": "#/$defs/quarterlyCashFlow" } },
        "incomeVsExpenses": { "$ref": "#/$defs/incomeVsExpenses" },
        "lenderSummary": { "$ref": "#/$defs/lenderSummary" },
        "taxPreparation": { "$ref": "#/$defs/taxPreparation" }
      }
    },
    "balanceCheck": {
      "type": "object",
      "additionalProperties": false,
      "required": ["passed", "beginningBalance", "endingBalance", "totalCredits", "totalDebits", "calculatedEnding", "delta"],
      "properties": {
        "passed": { "type": "boolean" },
        "beginningBalance": { "type": "number" },
        "endingBalance": { "type": "number" },
        "totalCredits": { "type": "number" },
        "totalDebits": { "type": "number" },
        "calculatedEnding": { "type": "number" },
        "delta": { "type": "number" }
      }
    },
    "transactionCheck": {
      "type": "object",
      "additionalProperties": false,
      "required": ["passed", "expectedCount", "actualCount"],
      "properties": {
        "passed": { "type": "boolean" },
        "expectedCount": { "type": "integer", "minimum": 0 },
        "actualCount": { "type": "integer", "minimum": 0 }
      }
    },
    "balanceDiscrepancy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["statementId", "periodLabel", "expectedEndingBalance", "actualEndingBalance", "delta", "equation", "severity", "message"],
      "properties": {
        "statementId": { "type": "string" },
        "periodLabel": { "type": "string" },
        "expectedEndingBalance": { "type": "number" },
        "actualEndingBalance": { "type": "number" },
        "delta": { "type": "number" },
        "equation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["beginningBalance", "totalCredits", "totalDebits", "calculatedEnding"],
          "properties": {
            "beginningBalance": { "type": "number" },
            "totalCredits": { "type": "number" },
            "totalDebits": { "type": "number" },
            "calculatedEnding": { "type": "number" }
          }
        },
        "severity": { "type": "string", "enum": ["info", "warning", "error"] },
        "message": { "type": "string" }
      }
    },
    "statementIntegrityResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["statementId", "periodLabel", "isValid", "balanceCheck", "transactionCheck", "discrepancies"],
      "properties": {
        "statementId": { "type": "string" },
        "periodLabel": { "type": "string" },
        "isValid": { "type": "boolean" },
        "balanceCheck": { "$ref": "#/$defs/balanceCheck" },
        "transactionCheck": { "$ref": "#/$defs/transactionCheck" },
        "discrepancies": { "type": "array", "items": { "$ref": "#/$defs/balanceDiscrepancy" } }
      }
    },
    "integrityCheck": {
      "type": "object",
      "additionalProperties": false,
      "required": ["overallValid", "statementsChecked", "statementsWithIssues", "statementResults", "summary"],
      "properties": {
        "overallValid": { "type": "boolean" },
        "statementsChecked": { "type": "integer", "minimum": 0 },
        "statementsWithIssues": { "type": "integer", "minimum": 0 },
        "statementResults": { "type": "array", "items": { "$ref": "#/$defs/statementIntegrityResult" } },
        "summary": {
          "type": "object",
          "additionalProperties": false,
          "required": ["totalDiscrepancies", "totalDelta", "warnings"],
          "properties": {
            "totalDiscrepancies": { "type": "integer", "minimum": 0 },
            "totalDelta": { "type": "number" },
            "warnings": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    }
  }
}
