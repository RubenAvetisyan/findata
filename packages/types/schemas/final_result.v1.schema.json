{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/final_result.v1.schema.json",
  "title": "Bank Statement Parser Output (v1) - Bank of America Specific",
  "description": "Schema for Bank of America statement parser output. Institution and currency constraints (const 'Bank of America', const 'USD') are intentional for this BOA-specific project. For multi-bank support, these would need to be relaxed in a future schema version.",
  "type": "object",
  "additionalProperties": false,
  "required": ["statements", "totalStatements", "totalTransactions"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "v1"
    },
    "schemaRevision": {
      "type": "string",
      "description": "Optional minor revision indicator (e.g., '1.0.1') without changing schemaVersion"
    },
    "statements": {
      "type": "array",
      "items": { "$ref": "#/$defs/statement" }
    },
    "totalStatements": {
      "type": "integer",
      "minimum": 0
    },
    "totalTransactions": {
      "type": "integer",
      "minimum": 0
    },
    "parseErrors": {
      "type": "array",
      "items": { "$ref": "#/$defs/parseError" }
    },
    "recurring": { "$ref": "#/$defs/recurringDetection" }
  },
  "$defs": {
    "isoDate": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "Date in YYYY-MM-DD format"
    },
    "isoDateTime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 date-time"
    },
    "accountType": {
      "type": "string",
      "enum": ["checking", "savings", "credit"]
    },
    "direction": {
      "type": "string",
      "enum": ["debit", "credit"]
    },
    "statementPeriod": {
      "type": "object",
      "additionalProperties": false,
      "required": ["start", "end"],
      "properties": {
        "start": { "$ref": "#/$defs/isoDate" },
        "end": { "$ref": "#/$defs/isoDate" }
      }
    },
    "account": {
      "type": "object",
      "additionalProperties": false,
      "required": ["institution", "accountType", "accountNumberMasked", "statementPeriod", "currency"],
      "properties": {
        "institution": {
          "type": "string",
          "const": "Bank of America"
        },
        "accountType": { "$ref": "#/$defs/accountType" },
        "accountNumberMasked": {
          "type": "string",
          "pattern": "^\\*{4}\\d{4}$",
          "description": "Masked account number like ****1234"
        },
        "statementPeriod": { "$ref": "#/$defs/statementPeriod" },
        "currency": {
          "type": "string",
          "const": "USD"
        }
      }
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["startingBalance", "endingBalance", "totalCredits", "totalDebits"],
      "properties": {
        "startingBalance": { "type": "number" },
        "endingBalance": { "type": "number" },
        "totalCredits": { "type": "number" },
        "totalDebits": { "type": "number" }
      }
    },
    "rawTransactionData": {
      "type": "object",
      "additionalProperties": false,
      "required": ["originalText", "page"],
      "properties": {
        "originalText": { "type": "string" },
        "page": { "type": "integer", "minimum": 1 }
      }
    },
    "transaction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["date", "postedDate", "description", "merchant", "amount", "direction", "category", "subcategory", "confidence", "raw"],
      "properties": {
        "date": { "$ref": "#/$defs/isoDate" },
        "postedDate": {
          "anyOf": [
            { "$ref": "#/$defs/isoDate" },
            { "type": "null" }
          ]
        },
        "description": { "type": "string", "minLength": 1 },
        "merchant": {
          "anyOf": [
            { "type": "string", "minLength": 1 },
            { "type": "null" }
          ]
        },
        "amount": { "type": "number" },
        "direction": { "$ref": "#/$defs/direction" },
        "category": { "type": "string", "minLength": 1 },
        "subcategory": {
          "anyOf": [
            { "type": "string" },
            { "type": "null" }
          ]
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "raw": { "$ref": "#/$defs/rawTransactionData" },
        "transactionId": {
          "type": "string",
          "minLength": 27,
          "maxLength": 27,
          "pattern": "^tx_[a-f0-9]{24}$",
          "description": "Deterministic unique transaction identifier (OFX FITID-equivalent). Format: tx_ + 24 hex chars from SHA-256 hash."
        }
      }
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["parserVersion", "parsedAt", "warnings"],
      "properties": {
        "parserVersion": { "type": "string" },
        "parsedAt": { "$ref": "#/$defs/isoDateTime" },
        "warnings": {
          "type": "array",
          "items": { "type": "string" }
        },
        "sourceFile": {
          "type": "string",
          "description": "Original source file name"
        }
      }
    },
    "statement": {
      "type": "object",
      "additionalProperties": false,
      "required": ["account", "summary", "transactions", "metadata"],
      "properties": {
        "account": { "$ref": "#/$defs/account" },
        "summary": { "$ref": "#/$defs/summary" },
        "transactions": {
          "type": "array",
          "items": { "$ref": "#/$defs/transaction" }
        },
        "metadata": { "$ref": "#/$defs/metadata" },
        "statementId": {
          "type": "string",
          "description": "Deterministic unique identifier for this statement (OFX-grade)"
        },
        "periodLabel": {
          "type": "string",
          "description": "Human-readable statement period label"
        }
      }
    },
    "parseError": {
      "type": "object",
      "additionalProperties": false,
      "required": ["filename", "error"],
      "properties": {
        "filename": { "type": "string" },
        "error": { "type": "string" }
      }
    },
    "recurringFrequency": {
      "type": "string",
      "enum": ["weekly", "bi-weekly", "monthly", "quarterly", "semi-annual", "annual", "irregular"]
    },
    "recurringPattern": {
      "type": "object",
      "additionalProperties": false,
      "required": ["patternId", "merchantKey", "merchantName", "frequency", "averageIntervalDays", "intervalStdDev", "averageAmount", "amountVariance", "isFixedAmount", "category", "subcategory", "direction", "occurrenceCount", "firstSeen", "lastSeen", "expectedNext", "confidence", "isSubscription", "transactionIds"],
      "properties": {
        "patternId": { "type": "string" },
        "merchantKey": { "type": "string" },
        "merchantName": { "type": "string" },
        "frequency": { "$ref": "#/$defs/recurringFrequency" },
        "averageIntervalDays": { "type": "number", "minimum": 0 },
        "intervalStdDev": { "type": "number", "minimum": 0 },
        "averageAmount": { "type": "number" },
        "amountVariance": { "type": "number", "minimum": 0 },
        "isFixedAmount": { "type": "boolean" },
        "category": { "type": "string" },
        "subcategory": { "anyOf": [{ "type": "string" }, { "type": "null" }] },
        "direction": { "$ref": "#/$defs/direction" },
        "occurrenceCount": { "type": "integer", "minimum": 2 },
        "firstSeen": { "$ref": "#/$defs/isoDate" },
        "lastSeen": { "$ref": "#/$defs/isoDate" },
        "expectedNext": { "anyOf": [{ "$ref": "#/$defs/isoDate" }, { "type": "null" }] },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "isSubscription": { "type": "boolean" },
        "transactionIds": { "type": "array", "items": { "type": "string" } }
      }
    },
    "recurringSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["totalPatterns", "totalRecurringTransactions", "recurringPercentage", "estimatedMonthlyRecurring", "estimatedAnnualRecurring", "byFrequency", "subscriptionCount"],
      "properties": {
        "totalPatterns": { "type": "integer", "minimum": 0 },
        "totalRecurringTransactions": { "type": "integer", "minimum": 0 },
        "recurringPercentage": { "type": "number", "minimum": 0, "maximum": 100 },
        "estimatedMonthlyRecurring": { "type": "number" },
        "estimatedAnnualRecurring": { "type": "number" },
        "byFrequency": {
          "type": "object",
          "additionalProperties": false,
          "required": ["weekly", "bi-weekly", "monthly", "quarterly", "semi-annual", "annual", "irregular"],
          "properties": {
            "weekly": { "type": "integer", "minimum": 0 },
            "bi-weekly": { "type": "integer", "minimum": 0 },
            "monthly": { "type": "integer", "minimum": 0 },
            "quarterly": { "type": "integer", "minimum": 0 },
            "semi-annual": { "type": "integer", "minimum": 0 },
            "annual": { "type": "integer", "minimum": 0 },
            "irregular": { "type": "integer", "minimum": 0 }
          }
        },
        "subscriptionCount": { "type": "integer", "minimum": 0 }
      }
    },
    "recurringDetection": {
      "type": "object",
      "additionalProperties": false,
      "required": ["patterns", "summary"],
      "properties": {
        "patterns": { "type": "array", "items": { "$ref": "#/$defs/recurringPattern" } },
        "summary": { "$ref": "#/$defs/recurringSummary" }
      }
    }
  }
}
